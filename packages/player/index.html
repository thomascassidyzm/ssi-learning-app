<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>SSi Learning Player</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SSi Learning Player v2
       Aesthetic: Premium Audio Ã— Clean Minimalism
       Flow: PROMPT â†’ PAUSE â†’ VOICE_1 â†’ VOICE_2
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    :root {
      /* SSi Red - The Accent */
      --ssi-red: #E63946;
      --ssi-red-soft: rgba(230, 57, 70, 0.12);
      --ssi-red-glow: rgba(230, 57, 70, 0.35);

      /* Success Green */
      --ssi-green: #10B981;
      --ssi-green-soft: rgba(16, 185, 129, 0.12);

      /* Typography */
      --font-display: 'DM Serif Display', Georgia, serif;
      --font-body: 'DM Sans', -apple-system, sans-serif;

      /* Timing */
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
      --ease-in-out: cubic-bezier(0.65, 0, 0.35, 1);

      /* Ring */
      --ring-size: 140px;
      --ring-stroke: 5px;
      --ring-radius: 62;
      --ring-circumference: 389.56; /* 2 * PI * 62 */
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DARK THEME (Default)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    :root, [data-theme="dark"] {
      --bg-primary: #0D0D0F;
      --bg-secondary: #1A1A1D;
      --bg-tertiary: #242428;
      --bg-elevated: #2C2C30;

      --text-primary: #FAFAFA;
      --text-secondary: rgba(250, 250, 250, 0.7);
      --text-tertiary: rgba(250, 250, 250, 0.45);
      --text-muted: rgba(250, 250, 250, 0.25);

      --border-subtle: rgba(255, 255, 255, 0.08);
      --border-light: rgba(255, 255, 255, 0.12);

      --shadow-elevated: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LIGHT THEME
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    [data-theme="light"] {
      --bg-primary: #FAFAFA;
      --bg-secondary: #F0F0F2;
      --bg-tertiary: #E8E8EB;
      --bg-elevated: #FFFFFF;

      --text-primary: #1A1A1D;
      --text-secondary: rgba(26, 26, 29, 0.7);
      --text-tertiary: rgba(26, 26, 29, 0.5);
      --text-muted: rgba(26, 26, 29, 0.25);

      --border-subtle: rgba(0, 0, 0, 0.06);
      --border-light: rgba(0, 0, 0, 0.1);

      --shadow-elevated: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESET & BASE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONTAINER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .player {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .player-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 1rem;
    }

    .course-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 100px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .course-badge .flag {
      font-size: 1rem;
    }

    .theme-toggle {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border: none;
      border-radius: 50%;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .theme-toggle svg {
      width: 18px;
      height: 18px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN CONTENT AREA
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .player-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2rem;
      padding: 1rem 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PROGRESS RING
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .ring-container {
      position: relative;
      width: var(--ring-size);
      height: var(--ring-size);
      flex-shrink: 0;
    }

    .ring-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .ring-track {
      fill: none;
      stroke: var(--border-subtle);
      stroke-width: var(--ring-stroke);
    }

    .ring-progress {
      fill: none;
      stroke: var(--ssi-red);
      stroke-width: var(--ring-stroke);
      stroke-linecap: round;
      stroke-dasharray: var(--ring-circumference);
      stroke-dashoffset: var(--ring-circumference);
      transition: stroke-dashoffset 0.1s linear;
    }

    .ring-progress.has-glow {
      filter: drop-shadow(0 0 8px var(--ssi-red-glow));
    }

    /* Ring Icon Container */
    .ring-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .speaker-icon {
      width: 40px;
      height: 40px;
      color: var(--ssi-red);
      opacity: 0.9;
      transition: transform 0.3s var(--ease-out-back), opacity 0.2s ease;
    }

    .speaker-icon.active {
      animation: pulse-icon 0.8s var(--ease-in-out) infinite;
    }

    @keyframes pulse-icon {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.1); opacity: 1; }
    }

    /* Sound Ripples */
    .sound-ripples {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .ripple {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 56px;
      height: 56px;
      margin: -28px 0 0 -28px;
      border: 2px solid var(--ssi-red);
      border-radius: 50%;
      opacity: 0;
    }

    .sound-ripples.active .ripple {
      animation: ripple-out 1.5s var(--ease-out-expo) infinite;
    }

    .ripple:nth-child(2) { animation-delay: 0.4s; }
    .ripple:nth-child(3) { animation-delay: 0.8s; }

    @keyframes ripple-out {
      0% { transform: scale(1); opacity: 0.5; }
      100% { transform: scale(2.2); opacity: 0; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PHRASE DISPLAY
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .phrase-display {
      text-align: center;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.625rem;
      padding: 0 1rem;
    }

    .phrase-text {
      font-family: var(--font-display);
      font-size: 1.75rem;
      font-weight: 400;
      line-height: 1.35;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 0.4s var(--ease-out-expo), transform 0.4s var(--ease-out-expo);
    }

    .phrase-text.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .phrase-text .highlight {
      color: var(--ssi-red);
    }

    .phrase-translation {
      font-family: var(--font-body);
      font-size: 1rem;
      font-weight: 400;
      color: var(--text-tertiary);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.35s var(--ease-out-expo) 0.08s, transform 0.35s var(--ease-out-expo) 0.08s;
    }

    .phrase-translation.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Phase Indicator */
    .phase-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding: 0.375rem 0.875rem;
      background: var(--bg-secondary);
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      opacity: 0;
      transition: opacity 0.3s ease, background-color 0.3s ease, color 0.3s ease;
    }

    .phase-indicator.visible {
      opacity: 1;
    }

    .phase-indicator.speaking {
      background: var(--ssi-red-soft);
      color: var(--ssi-red);
    }

    .phase-indicator .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .phase-indicator.speaking .dot {
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONTROL BAR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .control-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 100px;
      padding: 0.375rem;
      box-shadow: var(--shadow-elevated);
    }

    .control-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.1875rem;
      width: 72px;
      padding: 0.625rem 0;
      background: transparent;
      border: none;
      border-radius: 100px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .control-btn:hover {
      background: var(--bg-tertiary);
    }

    .control-btn:active {
      transform: scale(0.97);
    }

    .control-btn svg {
      width: 22px;
      height: 22px;
      color: var(--ssi-red);
    }

    .control-btn span {
      font-size: 0.625rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .control-divider {
      width: 1px;
      height: 28px;
      background: var(--border-light);
      margin: 0 0.125rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FOOTER - Belt Progress
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .player-footer {
      padding-top: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.625rem;
    }

    .belt-info {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      font-size: 0.8125rem;
      color: var(--text-tertiary);
    }

    .belt-info .belt-name {
      font-weight: 500;
      color: var(--text-secondary);
    }

    .belt-info .belt-progress {
      color: var(--text-primary);
      font-weight: 600;
    }

    .belt-track {
      width: 100%;
      max-width: 220px;
      height: 5px;
      background: var(--bg-tertiary);
      border-radius: 100px;
      overflow: hidden;
    }

    .belt-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--ssi-red), #F87171);
      border-radius: 100px;
      transition: width 0.5s var(--ease-out-expo);
    }

    /* Session counter */
    .session-counter {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    @media (max-width: 380px) {
      :root {
        --ring-size: 120px;
      }

      .phrase-text {
        font-size: 1.5rem;
      }

      .control-btn {
        width: 64px;
      }
    }

    @media (min-height: 750px) {
      .player-main {
        gap: 2.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="player" id="player">

    <!-- Header -->
    <header class="player-header">
      <div class="course-badge">
        <span class="flag">ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿</span>
        <span>Welsh</span>
      </div>
      <button class="theme-toggle" id="themeToggle" title="Toggle theme">
        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
    </header>

    <!-- Main Content -->
    <main class="player-main">

      <!-- Progress Ring -->
      <div class="ring-container" id="ringContainer">
        <svg class="ring-svg" viewBox="0 0 140 140">
          <circle class="ring-track" cx="70" cy="70" r="62" />
          <circle class="ring-progress" id="ringProgress" cx="70" cy="70" r="62" />
        </svg>

        <div class="sound-ripples" id="soundRipples">
          <div class="ripple"></div>
          <div class="ripple"></div>
          <div class="ripple"></div>
        </div>

        <div class="ring-icon">
          <svg class="speaker-icon" id="speakerIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
          </svg>
        </div>
      </div>

      <!-- Phrase Display -->
      <div class="phrase-display">
        <div class="phrase-text" id="phraseText"></div>
        <div class="phrase-translation" id="phraseTranslation"></div>
        <div class="phase-indicator" id="phaseIndicator">
          <span class="dot"></span>
          <span class="label">Listen</span>
        </div>
      </div>

      <!-- Controls -->
      <div class="control-bar">
        <button class="control-btn" id="btnRevisit">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
          </svg>
          <span>Revisit</span>
        </button>
        <div class="control-divider"></div>
        <button class="control-btn" id="btnPause">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="6" y="4" width="4" height="16"></rect>
            <rect x="14" y="4" width="4" height="16"></rect>
          </svg>
          <span>Pause</span>
        </button>
        <div class="control-divider"></div>
        <button class="control-btn" id="btnSkip">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 4 15 12 5 20 5 4"></polygon>
            <line x1="19" y1="5" x2="19" y2="19"></line>
          </svg>
          <span>Skip</span>
        </button>
      </div>

    </main>

    <!-- Footer -->
    <footer class="player-footer">
      <div class="belt-info">
        <span class="belt-name">White Belt</span>
        <span>Â·</span>
        <span class="belt-progress" id="beltPercent">40%</span>
      </div>
      <div class="belt-track">
        <div class="belt-fill" id="beltFill" style="width: 40%"></div>
      </div>
      <div class="session-counter" id="sessionCounter">3 of 15 phrases</div>
    </footer>

  </div>

  <script>
    /**
     * SSi Learning Player v2
     *
     * Phase Flow:
     * 1. PROMPT - Play known language audio + show text
     * 2. PAUSE  - Learner speaks (timer countdown)
     * 3. VOICE_1 - Play target audio (no text yet)
     * 4. VOICE_2 - Play target audio + show target text
     */

    class SSiPlayer {
      constructor() {
        this.els = {
          player: document.getElementById('player'),
          themeToggle: document.getElementById('themeToggle'),
          ringProgress: document.getElementById('ringProgress'),
          ringContainer: document.getElementById('ringContainer'),
          soundRipples: document.getElementById('soundRipples'),
          speakerIcon: document.getElementById('speakerIcon'),
          phraseText: document.getElementById('phraseText'),
          phraseTranslation: document.getElementById('phraseTranslation'),
          phaseIndicator: document.getElementById('phaseIndicator'),
          beltPercent: document.getElementById('beltPercent'),
          beltFill: document.getElementById('beltFill'),
          sessionCounter: document.getElementById('sessionCounter'),
          btnRevisit: document.getElementById('btnRevisit'),
          btnPause: document.getElementById('btnPause'),
          btnSkip: document.getElementById('btnSkip'),
        };

        this.circumference = 2 * Math.PI * 62;
        this.pauseDuration = 4000;
        this.animationFrame = null;
        this.currentPhase = 'idle';
        this.isPaused = false;
        this.phraseIndex = 0;
        this.beltProgress = 40;

        this.phrases = [
          { known: "I'm learning Welsh", target: "Dw i'n dysgu Cymraeg", targetHighlight: "<span class='highlight'>Dw i'n dysgu</span> Cymraeg" },
          { known: "Good morning", target: "Bore da", targetHighlight: "<span class='highlight'>Bore da</span>" },
          { known: "How are you?", target: "Sut mae?", targetHighlight: "<span class='highlight'>Sut mae?</span>" },
          { known: "Thank you very much", target: "Diolch yn fawr", targetHighlight: "Diolch <span class='highlight'>yn fawr</span>" },
          { known: "Nice to meet you", target: "Mae'n braf cwrdd Ã¢ chi", targetHighlight: "Mae'n <span class='highlight'>braf</span> cwrdd Ã¢ chi" },
        ];

        this.init();
      }

      init() {
        // Initialize ring
        this.els.ringProgress.style.strokeDasharray = this.circumference;
        this.els.ringProgress.style.strokeDashoffset = this.circumference;

        // Theme toggle
        this.els.themeToggle.addEventListener('click', () => this.toggleTheme());

        // Control buttons
        this.els.btnRevisit.addEventListener('click', () => this.revisit());
        this.els.btnPause.addEventListener('click', () => this.togglePause());
        this.els.btnSkip.addEventListener('click', () => this.skip());

        // Load saved theme
        const savedTheme = localStorage.getItem('ssi-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        this.updateThemeIcon(savedTheme);

        // Start
        this.startPhraseCycle();
      }

      toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('ssi-theme', next);
        this.updateThemeIcon(next);
      }

      updateThemeIcon(theme) {
        const svg = this.els.themeToggle.querySelector('svg');
        if (theme === 'dark') {
          svg.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
        } else {
          svg.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
        }
      }

      setPhase(phase, data = {}) {
        this.currentPhase = phase;
        const { phraseText, phraseTranslation, phaseIndicator, soundRipples, speakerIcon, ringProgress } = this.els;

        // Reset states
        soundRipples.classList.remove('active');
        speakerIcon.classList.remove('active');
        phaseIndicator.classList.remove('speaking');
        ringProgress.classList.remove('has-glow');
        this.setRingProgress(0);

        switch (phase) {
          case 'prompt':
            // Show known language, play audio
            phraseText.innerHTML = data.known || '';
            phraseText.classList.add('visible');
            phraseTranslation.textContent = '';
            phraseTranslation.classList.remove('visible');
            this.setPhaseLabel('Listen', false);
            soundRipples.classList.add('active');
            speakerIcon.classList.add('active');
            break;

          case 'pause':
            // User's turn to speak - countdown timer
            phraseText.innerHTML = data.known || '';
            phraseText.classList.add('visible');
            phraseTranslation.classList.remove('visible');
            this.setPhaseLabel('Your turn', true);
            ringProgress.classList.add('has-glow');
            this.startPauseTimer();
            break;

          case 'voice_1':
            // Play target voice 1 - no text shown
            phraseText.classList.remove('visible');
            phraseTranslation.classList.remove('visible');
            this.setPhaseLabel('Listen', false);
            soundRipples.classList.add('active');
            speakerIcon.classList.add('active');
            break;

          case 'voice_2':
            // Play target voice 2 + show target text
            phraseText.innerHTML = data.targetHighlight || data.target || '';
            phraseText.classList.add('visible');
            phraseTranslation.textContent = data.known || '';
            phraseTranslation.classList.add('visible');
            this.setPhaseLabel('Listen & Read', false);
            soundRipples.classList.add('active');
            speakerIcon.classList.add('active');
            break;

          case 'transition':
            phraseText.classList.remove('visible');
            phraseTranslation.classList.remove('visible');
            phaseIndicator.classList.remove('visible');
            break;
        }
      }

      setPhaseLabel(text, isSpeaking) {
        const indicator = this.els.phaseIndicator;
        indicator.querySelector('.label').textContent = text;
        indicator.classList.add('visible');
        if (isSpeaking) {
          indicator.classList.add('speaking');
        }
      }

      setRingProgress(progress) {
        const offset = this.circumference - (progress * this.circumference);
        this.els.ringProgress.style.strokeDashoffset = offset;
      }

      startPauseTimer() {
        const start = performance.now();
        const duration = this.pauseDuration;

        const animate = (now) => {
          if (this.isPaused || this.currentPhase !== 'pause') return;

          const elapsed = now - start;
          const progress = Math.min(elapsed / duration, 1);
          this.setRingProgress(progress);

          if (progress < 1) {
            this.animationFrame = requestAnimationFrame(animate);
          } else {
            this.onPauseComplete();
          }
        };

        this.animationFrame = requestAnimationFrame(animate);
      }

      onPauseComplete() {
        // Brief success moment, then continue
        setTimeout(() => {
          if (this.currentPhase === 'pause') {
            this.continueAfterPause();
          }
        }, 200);
      }

      async startPhraseCycle() {
        const phrase = this.phrases[this.phraseIndex];
        this.updateSessionCounter();

        // Phase 1: PROMPT (2s)
        this.setPhase('prompt', phrase);
        await this.wait(2000);
        if (this.isPaused) return;

        // Phase 2: PAUSE (4s timer)
        this.setPhase('pause', phrase);
        await this.wait(this.pauseDuration + 300);
        if (this.isPaused) return;

        this.continueAfterPause();
      }

      async continueAfterPause() {
        const phrase = this.phrases[this.phraseIndex];

        // Phase 3: VOICE_1 (2s)
        this.setPhase('voice_1', phrase);
        await this.wait(2000);
        if (this.isPaused) return;

        // Phase 4: VOICE_2 (2.5s)
        this.setPhase('voice_2', phrase);
        await this.wait(2500);
        if (this.isPaused) return;

        // Transition to next
        this.nextPhrase();
      }

      nextPhrase() {
        this.setPhase('transition');
        this.phraseIndex = (this.phraseIndex + 1) % this.phrases.length;

        // Update progress
        this.beltProgress = Math.min(this.beltProgress + 5, 100);
        this.els.beltPercent.textContent = this.beltProgress + '%';
        this.els.beltFill.style.width = this.beltProgress + '%';

        setTimeout(() => this.startPhraseCycle(), 600);
      }

      updateSessionCounter() {
        const current = this.phraseIndex + 1;
        const total = this.phrases.length;
        this.els.sessionCounter.textContent = `${current} of ${total} phrases`;
      }

      revisit() {
        cancelAnimationFrame(this.animationFrame);
        this.startPhraseCycle();
      }

      togglePause() {
        this.isPaused = !this.isPaused;
        const btn = this.els.btnPause;

        if (this.isPaused) {
          cancelAnimationFrame(this.animationFrame);
          btn.querySelector('svg').innerHTML = '<polygon points="5 4 19 12 5 20 5 4"></polygon>';
          btn.querySelector('span').textContent = 'Play';
        } else {
          btn.querySelector('svg').innerHTML = '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>';
          btn.querySelector('span').textContent = 'Pause';
          this.startPhraseCycle();
        }
      }

      skip() {
        cancelAnimationFrame(this.animationFrame);
        this.nextPhrase();
      }

      wait(ms) {
        return new Promise(resolve => {
          const check = () => {
            if (this.isPaused) {
              setTimeout(check, 100);
            } else {
              setTimeout(resolve, ms);
            }
          };
          check();
        });
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      window.ssiPlayer = new SSiPlayer();
    });
  </script>
</body>
</html>
