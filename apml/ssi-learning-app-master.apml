# APML v1.1.0 - Master Specification
# SSI Learning App v1.0.0
# Single Source of Truth (SSoT) for entire project

app SSiLearningApp:
  title: "SSI Learning App"
  version: "1.0.0"
  apml_version: "1.1.0"

  description: |
    Language learning player that delivers SSI courses to learners.
    Consumes content generated by ssi-dashboard-v7-clean and provides
    an immersive 4-phase prompt-response learning experience.

  compilation_method: "forward-compilation"
  generated_from: "Working v1.0.0 codebase (2025-12-03)"
  last_updated: "2025-12-03"

  ## ==========================================================================
  ## RELATIONSHIP TO DASHBOARD
  ## ==========================================================================

  ecosystem_relationship:
    dashboard_app:
      repo: "ssi-dashboard-v7-clean"
      role: "Content Creation"
      outputs:
        # Database-first (current architecture)
        - "Supabase: course_seeds, course_legos, course_phrases"
        - "Supabase: audio_samples (shared across courses)"
        - "S3: mastered/{uuid}.mp3"
        # Legacy (for native app compatibility)
        - lego_pairs.json
        - lego_baskets.json
        - course_manifest.json

    learning_app:
      repo: "ssi-learning-app"
      role: "Content Delivery"
      consumes:
        # Database-first (new architecture)
        - "Supabase: course content with delta sync"
        - "Supabase: learner progress"
        - "S3/CDN: Audio files by UUID"
        # Legacy fallback
        - course_manifest.json
      provides:
        - Learning experience
        - Progress tracking
        - Adaptive pacing
        - Offline PWA support

    data_flow:
      production: "Dashboard → Supabase + S3 → Learning App (delta sync) → Learner"
      legacy: "Dashboard → S3 → manifest.json → Learning App → Learner"

    shared_resources:
      variable_registry: "apml/core/ssi-variable-registry.apml"
      supabase_project: "Shared between dashboard and learning app"
      audio_storage: "S3 popty-bach-lfs (audio reused across courses)"

  ## ==========================================================================
  ## CORE SPECIFICATIONS
  ## ==========================================================================

  import core/data-types:
    status: "extracted"
    date: "2025-12-03"
    source: "packages/core/src/data/types.ts"
    coverage: "100% of data structures"
    notes: "Being aligned with variable registry"

  import core/ssi-variable-registry:
    status: "authoritative"
    date: "2025-12-13"
    source: "apml/core/ssi-variable-registry.apml"
    coverage: "All enums, entities, and data structures"
    description: |
      Single Source of Truth for:
      - ContentStatus, LegoType, PhraseType, AudioRole enums
      - Course, CourseSeed, CourseLego, CoursePracticePhrase entities
      - AudioSample (course-agnostic, reusable)
      - LearnerProgress (spaced repetition state)
      - Sync strategy for PWA delta sync
    generates:
      - "Supabase schema SQL"
      - "TypeScript interfaces"
      - "JSON Schema validators"

  import core/variable-registry:
    status: "deprecated"
    superseded_by: "core/ssi-variable-registry"
    date: "2025-12-03"
    source: "packages/core/src/**/*.ts, packages/player-vue/src/**/*.vue"
    coverage: "Core types, engine interfaces, UI state"

  ## ==========================================================================
  ## ENGINE SPECIFICATIONS
  ## ==========================================================================

  import engine/cycle-orchestrator:
    status: "extracted"
    date: "2025-12-03"
    source: "packages/core/src/engine/CycleOrchestrator.ts"
    coverage: "4-phase state machine, events, text visibility rules"

  import engine/audio-controller:
    status: "extracted"
    date: "2025-12-03"
    source: "packages/player-vue/src/components/LearningPlayer.vue"
    coverage: "HTML5 Audio handling, mobile compatibility, preloading"

  ## ==========================================================================
  ## LEARNING ALGORITHM SPECIFICATIONS
  ## ==========================================================================

  import learning/triple-helix:
    status: "designed"
    date: "2025-12-03"
    source: "packages/core/src/learning/TripleHelixEngine.ts"
    coverage: "Thread interleaving, seed progression"

  import learning/spaced-repetition:
    status: "designed"
    date: "2025-12-03"
    source: "packages/core/src/learning/SpacedRepetitionQueue.ts"
    coverage: "Fibonacci-based skip numbers, retirement"

  import learning/adaptation:
    status: "designed"
    date: "2025-12-03"
    source: "packages/core/src/learning/AdaptationEngine.ts"
    coverage: "Latency tracking, spike detection, difficulty adjustment"

  ## ==========================================================================
  ## PERSISTENCE SPECIFICATIONS
  ## ==========================================================================

  import persistence/progress-store:
    status: "designed"
    date: "2025-12-03"
    source: "packages/core/src/persistence/ProgressStore.ts"
    coverage: "IndexedDB storage, Supabase sync"

  import persistence/session-store:
    status: "designed"
    date: "2025-12-03"
    source: "packages/core/src/persistence/SessionStore.ts"
    coverage: "Session state snapshots, resume capability"

  ## ==========================================================================
  ## INTERFACE SPECIFICATIONS
  ## ==========================================================================

  import interfaces/learning-player:
    status: "extracted"
    date: "2025-12-03"
    source: "packages/player-vue/src/components/LearningPlayer.vue"
    coverage: "Moonlit Dojo UI, belt system, phase visualization"

  import interfaces/session-complete:
    status: "extracted"
    date: "2025-12-03"
    source: "packages/player-vue/src/components/SessionComplete.vue"
    coverage: "Session summary, progress display, resume action"

  ## ==========================================================================
  ## PSS COMPLIANCE (Project Structure Standard)
  ## ==========================================================================

  pss_compliance:
    structure_standard: "APML-PSS v1.0.0"
    self_documentation: enabled

    directory_mapping:
      apml/core/: "Core data types and variable registry"
      apml/engine/: "CycleOrchestrator and AudioController specs"
      apml/learning/: "Learning algorithm specifications"
      apml/persistence/: "Storage and sync specifications"
      apml/interfaces/: "UI component specifications"
      apml/validation/: "Validation rules and constraints"

    current_structure:
      compliant: true
      reason: "Monorepo follows PSS principles"

  ## ==========================================================================
  ## COMPILATION TARGETS
  ## ==========================================================================

  deterministic_compilation:
    target_platform: "Vue 3 + TypeScript"
    core_framework: "Framework-agnostic TypeScript"
    ui_adapter: "Vue 3 Composition API"
    styling: "Scoped CSS (Moonlit Dojo theme)"
    compilation_guarantee: "Specification-driven development"

  build_configuration:
    monorepo:
      manager: "pnpm workspaces"
      packages:
        - "@ssi/core"
        - "player-vue"

    core:
      entry: "packages/core/src/index.ts"
      output: "packages/core/dist/"
      build_tool: "tsup"

    player:
      entry: "packages/player-vue/src/main.js"
      output: "packages/player-vue/dist/"
      dev_server: "http://localhost:5173"
      build_tool: "vite"

    deployment:
      platform: "Vercel"
      build_command: "pnpm --filter @ssi/core build && pnpm --filter player-vue build"
      output_directory: "packages/player-vue/dist"

  ## ==========================================================================
  ## VALIDATION AND QUALITY GATES
  ## ==========================================================================

  validate trinity_completeness:
    system_to_user:
      status: "complete"
      coverage: "Phase indicators, text display, ring progress, belt status"
      documented_in: "interfaces/learning-player.apml"

    user_to_system:
      status: "complete"
      coverage: "Play/pause, skip, revisit, turbo mode, listening mode"
      documented_in: "interfaces/learning-player.apml"

    system_to_system:
      status: "complete"
      coverage: "CycleOrchestrator events, audio callbacks, state transitions"
      documented_in: "engine/cycle-orchestrator.apml"

  validate pss_compliance:
    check directory_structure_complete:
      status: "complete"
      existing: ["apml/core/", "apml/engine/", "apml/learning/", "apml/persistence/", "apml/interfaces/"]

    check self_documentation_generated:
      status: "pending"
      required: ["CLAUDE.md (done)", "Architecture diagrams (pending)"]
      current: ["CLAUDE.md"]

  ## ==========================================================================
  ## VERSION HISTORY
  ## ==========================================================================

  version_history:
    v1.0.0:
      date: "2025-12-03"
      title: "Initial APML Specification"
      features:
        - "CycleOrchestrator 4-phase state machine"
        - "RealAudioController with mobile compatibility"
        - "Moonlit Dojo UI design"
        - "Belt progression system (8 belts)"
        - "Dynamic pause duration (2x target audio)"
        - "Real Italian course audio integration"

      architecture:
        - "Monorepo with @ssi/core and player-vue"
        - "Framework-agnostic TypeScript core"
        - "Vue 3 Composition API adapter"

      pending:
        - "Supabase integration"
        - "Speech recognition"
        - "Triple Helix threading"

  ## ==========================================================================
  ## EXTRACTION STATUS
  ## ==========================================================================

  extraction_progress:
    completed:
      - "core/data-types.apml (100%)"
      - "engine/cycle-orchestrator.apml (100%)"
      - "interfaces/learning-player.apml (100%)"

    in_progress:
      - "core/variable-registry.apml"
      - "engine/audio-controller.apml"

    pending:
      - "learning/triple-helix.apml"
      - "learning/spaced-repetition.apml"
      - "learning/adaptation.apml"
      - "persistence/progress-store.apml"
      - "persistence/session-store.apml"
      - "validation/gate-compliance.apml"

  ## ==========================================================================
  ## MAINTENANCE STRATEGY
  ## ==========================================================================

  living_documentation:
    principle: "APML evolves WITH code, not after it"

    workflow:
      when_code_changes:
        1: "Update relevant APML segment(s)"
        2: "Update variable registry if new identifiers added"
        3: "Commit code + APML changes together"
        4: "APML stays current with reality"

    benefits:
      - "Specification never gets stale"
      - "Always reflects working codebase"
      - "Small focused files easy to update"
      - "Single source of truth maintained"

    file_size_target:
      max_lines_per_file: 500
      reason: "Maintainability and comprehension"

  ## ==========================================================================
  ## PROJECT METADATA
  ## ==========================================================================

  project:
    repository: "ssi-learning-app"
    deployment:
      production: "https://ssi-learning-app.vercel.app (pending)"
      local: "http://localhost:5173"

    technology_stack:
      core:
        - "TypeScript 5.x"
        - "tsup (build)"
        - "vitest (testing)"

      player:
        - "Vue 3 (Composition API)"
        - "Vite 7.x"
        - "Scoped CSS"

      storage:
        - "IndexedDB (offline)"
        - "Supabase (sync - pending)"

      audio:
        - "HTML5 Audio API"
        - "S3/CloudFront (CDN)"

    authors:
      - "Tom Cassidy (Human)"
      - "Claude (AI Assistant)"

    license: "Proprietary"

    related_projects:
      - repo: "ssi-dashboard-v7-clean"
        role: "Content creation pipeline"
      - repo: "ssi-schools-mockup"
        role: "Schools/classroom version"

  ## ==========================================================================
  ## APML SPECIFICATION METADATA
  ## ==========================================================================

  apml_metadata:
    specification_version: "1.1.0"
    compliance:
      variable_registry_standard: partial
      pss_standard: true
      intent_capture_methodology: "forward-compilation variant"

    generation_method:
      approach: "Forward-compilation from clean v1.0.0 codebase"
      reason: "Code is clean and working - capture reality"
      date: "2025-12-03"

    quality_metrics:
      data_types_coverage: "100%"
      engine_coverage: "100%"
      learning_coverage: "50% (designed, not fully tested)"
      persistence_coverage: "30% (designed)"
      interface_coverage: "100%"
      validation_coverage: "0% (pending)"

    next_steps:
      immediate:
        - "Extract remaining APML segments"
        - "Complete variable registry"
        - "Add validation specifications"

      medium_term:
        - "Supabase integration"
        - "Speech recognition"
        - "Full Triple Helix implementation"

      long_term:
        - "PWA offline capability"
        - "Schools version"
        - "Multi-platform deployment"

## ============================================================================
## MASTER SPECIFICATION v1.0.0
## Generated: 2025-12-03 via forward-compilation
## Status: Core complete, learning algorithms partial, persistence pending
## Method: Extract from reality (working code)
## ============================================================================
