# APML v2.0.0 - Master Specification
# SSI Learning App v2.0.0
# Single Source of Truth (SSoT) for entire project

app SSiLearningApp:
  title: "SSI Learning App"
  version: "2.2.0"
  apml_version: "2.0.0"

  description: |
    Language learning player that delivers SSI courses to learners.
    Consumes content generated by ssi-dashboard-v7-clean and provides
    an immersive 4-phase prompt-response learning experience with
    constellation network visualization.

    v2.2.0: Best-in-class audio caching with backend proxy, 30-min prefetch, graceful degradation.
    v2.1.0: Belt-aware progressive loading, cross-device sync, offline play.

  compilation_method: "forward-compilation"
  generated_from: "Working v2.2.0 codebase (2026-01-25)"
  last_updated: "2026-01-25"

  ## ==========================================================================
  ## RELATIONSHIP TO DASHBOARD
  ## ==========================================================================

  ecosystem_relationship:
    dashboard_app:
      repo: "ssi-dashboard-v7-clean"
      role: "Content Creation"
      outputs:
        # Database-first (current architecture)
        - "Supabase: course_seeds, course_legos, course_phrases"
        - "Supabase: audio_samples (shared across courses)"
        - "S3: mastered/{uuid}.mp3"
        # Legacy (for native app compatibility)
        - lego_pairs.json
        - lego_baskets.json
        - course_manifest.json

    learning_app:
      repo: "ssi-learning-app"
      role: "Content Delivery"
      consumes:
        # Database-first (new architecture)
        - "Supabase: course content with delta sync"
        - "Supabase: learner progress"
        - "S3/CDN: Audio files by UUID"
        # Legacy fallback
        - course_manifest.json
      provides:
        - Learning experience
        - Progress tracking
        - Adaptive pacing
        - Offline PWA support

    data_flow:
      production: "Dashboard → Supabase + S3 → Learning App (delta sync) → Learner"
      legacy: "Dashboard → S3 → manifest.json → Learning App → Learner"

    shared_resources:
      variable_registry: "apml/core/ssi-variable-registry.apml"
      supabase_project: "Shared between dashboard and learning app"
      audio_storage: "S3 ssi-audio-stage (audio reused across courses)"

  ## ==========================================================================
  ## CORE SPECIFICATIONS
  ## ==========================================================================

  import core/data-types:
    status: "extracted"
    date: "2025-12-03"
    source: "packages/core/src/data/types.ts"
    coverage: "100% of data structures"
    notes: "Being aligned with variable registry"

  import core/ssi-variable-registry:
    status: "authoritative"
    date: "2025-12-13"
    source: "apml/core/ssi-variable-registry.apml"
    coverage: "All enums, entities, and data structures"
    description: |
      Single Source of Truth for:
      - ContentStatus, LegoType, PhraseType, AudioRole enums
      - Course, CourseSeed, CourseLego, CoursePracticePhrase entities
      - AudioSample (course-agnostic, reusable)
      - LearnerProgress (spaced repetition state)
      - Sync strategy for PWA delta sync
    generates:
      - "Supabase schema SQL"
      - "TypeScript interfaces"
      - "JSON Schema validators"

  import core/variable-registry:
    status: "deprecated"
    superseded_by: "core/ssi-variable-registry"
    date: "2025-12-03"
    source: "packages/core/src/**/*.ts, packages/player-vue/src/**/*.vue"
    coverage: "Core types, engine interfaces, UI state"

  ## ==========================================================================
  ## ENGINE SPECIFICATIONS
  ## ==========================================================================

  import engine/cycle-orchestrator:
    status: "extracted"
    date: "2025-12-03"
    source: "packages/core/src/engine/CycleOrchestrator.ts"
    coverage: "4-phase state machine, events, text visibility rules"

  import engine/audio-controller:
    status: "extracted"
    date: "2025-12-03"
    source: "packages/player-vue/src/components/LearningPlayer.vue"
    coverage: "HTML5 Audio handling, mobile compatibility, preloading"

  ## ==========================================================================
  ## LEARNING ALGORITHM SPECIFICATIONS
  ## ==========================================================================

  import learning/triple-helix:
    status: "designed"
    date: "2025-12-03"
    source: "packages/core/src/learning/TripleHelixEngine.ts"
    coverage: "Thread interleaving, seed progression"

  import learning/spaced-repetition:
    status: "designed"
    date: "2025-12-03"
    source: "packages/core/src/learning/SpacedRepetitionQueue.ts"
    coverage: "Fibonacci-based skip numbers, retirement"

  import learning/adaptation:
    status: "designed"
    date: "2025-12-03"
    source: "packages/core/src/learning/AdaptationEngine.ts"
    coverage: "Latency tracking, spike detection, difficulty adjustment"

  ## ==========================================================================
  ## PERSISTENCE SPECIFICATIONS
  ## ==========================================================================

  import persistence/progressive-loading:
    status: "implemented"
    date: "2026-01-18"
    source: "packages/player-vue/src/composables/useBeltLoader.ts"
    coverage: |
      Belt-aware progressive loading, three-layer architecture,
      offline infinite play, cross-device sync via Supabase
    composables:
      - "useBeltLoader.ts - Priority queue loading"
      - "useOfflinePlay.ts - Infinite play mode"
      - "useBeltProgress.ts - Supabase sync enhancement"
    database:
      - "course_enrollments.highest_completed_seed column"
    ui:
      - "SettingsScreen.vue - Offline download UI"

  import persistence/progress-store:
    status: "implemented"
    date: "2026-01-18"
    source: "packages/core/src/persistence/ProgressStore.ts"
    coverage: |
      Supabase persistence for learner progress, enrollments,
      LEGO progress, seed progress, baselines

  import persistence/session-store:
    status: "designed"
    date: "2025-12-03"
    source: "packages/core/src/persistence/SessionStore.ts"
    coverage: "Session state snapshots, resume capability"

  ## ==========================================================================
  ## CACHE SPECIFICATIONS
  ## ==========================================================================

  import cache/audio-architecture:
    status: "implemented"
    date: "2026-01-25"
    source: "Multiple files - see apml/cache/audio-architecture.apml"
    coverage: |
      Backend proxy for audio (/api/audio/:audioId),
      30-minute rolling prefetch buffer,
      graceful degradation to infinite play,
      resumable downloads up to 10 hours,
      analytics tracking for all audio plays
    new_files:
      - "api/audio/[audioId].ts - Vercel serverless proxy"
      - "packages/player-vue/src/composables/usePrefetchManager.ts"
      - "packages/player-vue/src/config/audioConfig.ts"
      - "supabase/migrations/20260125000000_audio_plays.sql"
    key_principle: "Never show connection errors - always keep playing"

  ## ==========================================================================
  ## INTERFACE SPECIFICATIONS
  ## ==========================================================================

  import interfaces/learning-player:
    status: "current"
    date: "2026-01-09"
    source: "packages/player-vue/src/components/LearningPlayer.vue"
    coverage: |
      Deep Space Constellation UI, belt system, phase strip with icons,
      hero-centric glass pane, transport controls, intro mode
    version: "2.0.0"

  import interfaces/constellation-network:
    status: "current"
    date: "2026-01-09"
    source: "packages/player-vue/src/components/ConstellationNetworkView.vue"
    coverage: |
      Pre-built network visualization, hero-centric panning,
      path animation during voice phases, node tap playback,
      pinch-zoom and drag-pan interactions
    composables:
      - "usePrebuiltNetwork.ts"
      - "usePrebuiltNetworkIntegration.ts"

  import interfaces/session-complete:
    status: "extracted"
    date: "2025-12-03"
    source: "packages/player-vue/src/components/SessionComplete.vue"
    coverage: "Session summary, progress display, resume action"

  import interfaces/brain-view:
    status: "active-legacy"
    will_be_superseded_by: "interfaces/constellation-network"
    date: "2025-12-27"
    source: "packages/player-vue/src/components/LegoNetwork.vue"
    coverage: |
      D3 force simulation network - still used for replay mechanism.
      Live learning uses ConstellationNetworkView; replay uses LegoNetwork.

  ## ==========================================================================
  ## PSS COMPLIANCE (Project Structure Standard)
  ## ==========================================================================

  pss_compliance:
    structure_standard: "APML-PSS v1.0.0"
    self_documentation: enabled

    directory_mapping:
      apml/core/: "Core data types and variable registry"
      apml/engine/: "CycleOrchestrator and AudioController specs"
      apml/learning/: "Learning algorithm specifications"
      apml/persistence/: "Storage and sync specifications"
      apml/interfaces/: "UI component specifications"
      apml/validation/: "Validation rules and constraints"

    current_structure:
      compliant: true
      reason: "Monorepo follows PSS principles"

  ## ==========================================================================
  ## COMPILATION TARGETS
  ## ==========================================================================

  deterministic_compilation:
    target_platform: "Vue 3 + TypeScript"
    core_framework: "Framework-agnostic TypeScript"
    ui_adapter: "Vue 3 Composition API"
    styling: "Scoped CSS (Moonlit Dojo theme)"
    compilation_guarantee: "Specification-driven development"

  build_configuration:
    monorepo:
      manager: "pnpm workspaces"
      packages:
        - "@ssi/core"
        - "player-vue"

    core:
      entry: "packages/core/src/index.ts"
      output: "packages/core/dist/"
      build_tool: "tsup"

    player:
      entry: "packages/player-vue/src/main.js"
      output: "packages/player-vue/dist/"
      dev_server: "http://localhost:5173"
      build_tool: "vite"

    deployment:
      platform: "Vercel"
      build_command: "pnpm --filter @ssi/core build && pnpm --filter player-vue build"
      output_directory: "packages/player-vue/dist"

  ## ==========================================================================
  ## VALIDATION AND QUALITY GATES
  ## ==========================================================================

  validate trinity_completeness:
    system_to_user:
      status: "complete"
      coverage: "Phase indicators, text display, ring progress, belt status"
      documented_in: "interfaces/learning-player.apml"

    user_to_system:
      status: "complete"
      coverage: "Play/pause, skip, revisit, turbo mode, listening mode"
      documented_in: "interfaces/learning-player.apml"

    system_to_system:
      status: "complete"
      coverage: "CycleOrchestrator events, audio callbacks, state transitions"
      documented_in: "engine/cycle-orchestrator.apml"

  validate pss_compliance:
    check directory_structure_complete:
      status: "complete"
      existing: ["apml/core/", "apml/engine/", "apml/learning/", "apml/persistence/", "apml/interfaces/"]

    check self_documentation_generated:
      status: "pending"
      required: ["CLAUDE.md (done)", "Architecture diagrams (pending)"]
      current: ["CLAUDE.md"]

  ## ==========================================================================
  ## VERSION HISTORY
  ## ==========================================================================

  version_history:
    v2.1.0:
      date: "2026-01-18"
      title: "Belt-Aware Progressive Loading"
      features:
        - "Three-layer loading architecture (blocking/background/infinite)"
        - "Belt-aware priority queue (P0=current, P1-P5=next belts)"
        - "Fast startup (<2s on 3G with ~760KB initial load)"
        - "Skip-ahead support (breadth-first belt loading)"
        - "Infinite offline play (shuffle cached content forever)"
        - "Cross-device progress sync via Supabase"
        - "highest_completed_seed as stable anchor"
        - "Offline download UI in Settings"

      architecture:
        - "useBeltLoader for progressive loading with priority queue"
        - "useOfflinePlay for infinite play mode"
        - "useBeltProgress enhanced with Supabase sync"
        - "course_enrollments.highest_completed_seed column"

      design_decisions:
        - "User-controlled offline download (not automatic)"
        - "Seamless offline UX (invisible degradation)"
        - "max(local, remote) sync strategy (progress never goes backward)"

    v2.0.0:
      date: "2026-01-09"
      title: "Deep Space Constellation"
      features:
        - "ConstellationNetworkView with pre-calculated positions"
        - "Hero-centric panning (spatial memory preserved)"
        - "Phase strip with semantic icons (speaker/mic/eyes)"
        - "Hero glass pane with typewriter intro mode"
        - "Path animation during voice phases"
        - "Node tap playback"
        - "Transport controls in thumb zone"
        - "Progressive script loading (1000+ LEGOs)"
        - "Database-driven edge connections"

      architecture:
        - "usePrebuiltNetwork for position pre-calculation"
        - "usePrebuiltNetworkIntegration for learning session"
        - "useScriptCache for caching generated scripts"
        - "useMetaCommentary for intro messages"

      breaking_changes:
        - "Replaced Moonlit Dojo (central card) with Deep Space Constellation"
        - "Replaced ring progress with phase strip"
        - "Replaced fireflies with star field"
        - "Superseded brain-view.apml with constellation-network.apml"

    v1.0.0:
      date: "2025-12-03"
      title: "Moonlit Dojo (Initial APML Specification)"
      features:
        - "CycleOrchestrator 4-phase state machine"
        - "RealAudioController with mobile compatibility"
        - "Moonlit Dojo UI design"
        - "Belt progression system (8 belts)"
        - "Dynamic pause duration (2x target audio)"
        - "Real Italian course audio integration"

      architecture:
        - "Monorepo with @ssi/core and player-vue"
        - "Framework-agnostic TypeScript core"
        - "Vue 3 Composition API adapter"

      pending:
        - "Supabase integration"
        - "Speech recognition"
        - "Triple Helix threading"

  ## ==========================================================================
  ## EXTRACTION STATUS
  ## ==========================================================================

  extraction_progress:
    completed:
      - "core/data-types.apml (100%)"
      - "engine/cycle-orchestrator.apml (100%)"
      - "interfaces/learning-player.apml (100%)"
      - "interfaces/brain-view.apml (design complete)"
      - "interfaces/constellation-network.apml (100%)"
      - "persistence/progressive-loading.apml (100%)"

    in_progress:
      - "core/variable-registry.apml"
      - "engine/audio-controller.apml"

    pending:
      - "learning/triple-helix.apml"
      - "learning/spaced-repetition.apml"
      - "learning/adaptation.apml"
      - "persistence/session-store.apml"
      - "validation/gate-compliance.apml"

  ## ==========================================================================
  ## MAINTENANCE STRATEGY
  ## ==========================================================================

  living_documentation:
    principle: "APML evolves WITH code, not after it"

    workflow:
      when_code_changes:
        1: "Update relevant APML segment(s)"
        2: "Update variable registry if new identifiers added"
        3: "Commit code + APML changes together"
        4: "APML stays current with reality"

    benefits:
      - "Specification never gets stale"
      - "Always reflects working codebase"
      - "Small focused files easy to update"
      - "Single source of truth maintained"

    file_size_target:
      max_lines_per_file: 500
      reason: "Maintainability and comprehension"

  ## ==========================================================================
  ## PROJECT METADATA
  ## ==========================================================================

  project:
    repository: "ssi-learning-app"
    deployment:
      production: "https://ssi-learning-app.vercel.app (pending)"
      local: "http://localhost:5173"

    technology_stack:
      core:
        - "TypeScript 5.x"
        - "tsup (build)"
        - "vitest (testing)"

      player:
        - "Vue 3 (Composition API)"
        - "Vite 7.x"
        - "Scoped CSS"

      storage:
        - "IndexedDB (offline)"
        - "Supabase (sync - pending)"

      audio:
        - "HTML5 Audio API"
        - "S3/CloudFront (CDN)"

    authors:
      - "Tom Cassidy (Human)"
      - "Claude (AI Assistant)"

    license: "Proprietary"

    related_projects:
      - repo: "ssi-dashboard-v7-clean"
        role: "Content creation pipeline"
      - repo: "ssi-schools-mockup"
        role: "Schools/classroom version"

  ## ==========================================================================
  ## APML SPECIFICATION METADATA
  ## ==========================================================================

  apml_metadata:
    specification_version: "1.1.0"
    compliance:
      variable_registry_standard: partial
      pss_standard: true
      intent_capture_methodology: "forward-compilation variant"

    generation_method:
      approach: "Forward-compilation from clean v1.0.0 codebase"
      reason: "Code is clean and working - capture reality"
      date: "2025-12-03"

    quality_metrics:
      data_types_coverage: "100%"
      engine_coverage: "100%"
      learning_coverage: "50% (designed, not fully tested)"
      persistence_coverage: "80% (progressive loading + sync implemented)"
      interface_coverage: "100%"
      validation_coverage: "0% (pending)"

    next_steps:
      immediate:
        - "Extract remaining APML segments"
        - "Complete variable registry"
        - "Add validation specifications"
        - "Wire DownloadManager to offline download UI"

      medium_term:
        - "Speech recognition during PAUSE phase"
        - "Full Triple Helix implementation"
        - "Spaced repetition queue integration"

      long_term:
        - "Schools version"
        - "Multi-platform deployment"
        - "A/B testing framework"

## ============================================================================
## MASTER SPECIFICATION v1.0.0
## Generated: 2025-12-03 via forward-compilation
## Status: Core complete, learning algorithms partial, persistence pending
## Method: Extract from reality (working code)
## ============================================================================
