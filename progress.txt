# Cycle Refactor Progress

## Goal
Refactor SSi Learning App to use Cycles as atomic units where text and audio are bound together by ID, making text/audio mismatch structurally impossible.

## Background
- Current architecture has separate currentScriptItem and currentPlayableItem that can desync
- Audio sometimes looked up by text string (fragile)
- LearningPlayer.vue is 5000+ lines doing too much
- Need: Cycle as atomic unit, pre-validation before session, simple player

## Completed Tasks

### Item 0: Set up vitest (manual, pre-Ralph)
- Installed vitest, @vue/test-utils, happy-dom
- Created vitest.config.ts with happy-dom environment
- Added test, test:watch, typecheck, lint scripts to package.json
- Created setup.test.ts to verify - passes

### Items 1-3: Create Cycle type definitions
- Created /packages/player-vue/src/types/Cycle.ts with:
  - Cycle interface: atomic learning unit with known/target audio bound by ID
  - CachedAudio interface: IndexedDB audio representation
  - ValidationResult type: discriminated union for validation results
- Installed vue-tsc and typescript dev dependencies
- Created tsconfig.json and tsconfig.node.json for Vue 3 + TypeScript
- Fixed type assertion in ListeningModePlayer.vue (removed `as const`)
- Direct tsc verification confirms Cycle.ts compiles cleanly
- Updated ralph-prd.json: items 1-3 marked as passes: true

### Items 4-5: Create validation functions
- Created /packages/player-vue/src/utils/validateCycle.ts with:
  - validateCycle(): Checks single cycle has all 3 audio IDs in cache
  - validateSession(): Aggregates missing IDs across all cycles in session
  - Type guard for discriminated union access
- pnpm test passes (existing tests)
- Updated ralph-prd.json: items 4-5 marked as passes: true

## Current Blockers
(none)

## Notes for Next Iteration
Items 1-5 complete. Next: Item 6 - Write tests for validateCycle function.
