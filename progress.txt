# LearningPlayer Decomposition Progress

## Phase 1 Complete: Cycle Foundation
Created atomic Cycle types with validation, playback composable, player component.
- Cycle type definitions (types/Cycle.ts)
- validateCycle / validateSession (utils/validateCycle.ts)
- useCyclePlayback composable
- CyclePlayer.vue component (154 lines)
- 11 tests passing
- Test page at /test/cycle

## Phase 2 Complete: Decomposition

### Goal
Decompose 5000-line LearningPlayer.vue into focused modules using the Cycle foundation.

### Target Architecture
```
LearningSession.vue (thin orchestrator, <200 lines)
├── useSessionManager (queue, progression)
├── CyclePlayer (plays one cycle)
├── Events → Network visualization
├── Events → Belt progress
└── scriptItemToCycle bridge (gradual migration)
```

### Key Principle
LearningPlayer.vue stays working throughout. New modules are built alongside, wired via feature flag.

## Completed Tasks (Phase 2) - ALL COMPLETE
1. Created useSessionManager composable - queue/progression logic extracted
2. Wrote useSessionManager tests - 11 tests, all passing (22 total tests)
3. Created scriptItemToCycle bridge converter - maps ScriptItem to Cycle format
4-8. Created LearningSession.vue orchestrator (186 lines) with:
  - Session validation gate (blocks until audio ready)
  - Network visualization events (cycle-started with legoId)
  - Belt progress events (cycle-complete with cycle)
  - Skip and jump controls (exposed via ref)
9. Created SessionTestPage at /test/session - full session test with belt/event log
10. Added USE_NEW_SESSION feature flag in PlayerContainer (default: false)

## Summary
Phase 2 complete. All 10 PRD items passing.
- New modules: useSessionManager, scriptItemToCycle, LearningSession.vue
- Test coverage: 22 tests passing
- Backwards compatible: Old LearningPlayer unchanged, new system behind feature flag
- Test routes: /test/cycle and /test/session

## Phase 3: Cycle Playback Integration (Current)

### Goal
Swap LearningPlayer's internal playback engine from old CycleOrchestrator to new useCyclePlayback.
This is NOT a replacement - LearningPlayer keeps all its features, we just swap the playback mechanics.

### What Changed
1. **Script generation** - RoundEngine updated (BUILD capped at 7, components skipped, LEGO validation) - DONE
2. **Cycle playback** - Text+audio now LOCKED in Cycle objects by ID - DONE (p3-1)

### PRD
See ralph-prd-phase3.json for task breakdown (6 focused tasks).

### Key Principle
LearningPlayer.vue already works fantastically. We're only swapping the playback engine.
All existing features (audio fetching, belt progress, network, listening mode) stay as-is.

### Architecture
```
LearningPlayer.vue (5000 lines - KEEP ALL OF IT)
├── generateLearningScript() → scriptItems (already works)
├── Audio fetching from S3 (keep as-is)
├── Belt progress (keep as-is)
├── Network visualization (keep as-is, add fire-path event)
├── Listening mode (keep as-is)
└── Playback engine (SWAP THIS)
    ├── OLD: CycleOrchestrator from @ssi/core - REMOVED
    └── NEW: useCyclePlayback + scriptItemToCycle bridge - ACTIVE
```

### Brain View Architecture (for p3-3)
Use the NEW lightweight Three.js brain visualization:
- useBrainNodes.ts - GPU-accelerated particles (THREE.Points + BufferGeometry)
- useBrainFirePath.ts - Fire path animation (playFirePath({ nodeIds, duration }))
- Brain3DView.vue - The 3D renderer component

### Progress
- [x] p3-1: Swap LearningPlayer to use useCyclePlayback (HIGH RISK) - COMPLETE
  - Removed CycleOrchestrator import
  - Added useCyclePlayback composable
  - Created getAudioBlob for IndexedDB/fetch integration
  - Created startCyclePlayback wrapper (converts ScriptItem → Cycle → play)
  - Replaced all orchestrator.startItem calls with startCyclePlayback
  - Replaced orchestrator.stop with stopCycle
  - Added phase mapping watchers
  - All 22 tests passing
- [x] p3-2: Update phase rendering to use Cycle data - COMPLETE
  - Updated currentPhrase to read from currentCycle.known/target.text
  - Updated visibleTexts to read from currentCycle
  - Text and audio now LOCKED in same Cycle object
  - Phase-based visibility working (target only in VOICE_2)
  - All 22 tests passing
- [x] p3-3: Wire fire-path event to Brain3DView - COMPLETE
  - Added 'cycle-started' event emission in startCyclePlayback
  - Emits legoId and cycle duration for fire-path animation
  - Brain3DView can listen to this event for visualization
  - All 22 tests passing
- [x] p3-4: Verify belt progress still works - COMPLETE
  - Added 'cycle_completed' case to handleCycleEvent (falls through to item_completed)
  - learningSession.recordCycleComplete() called on cycle completion
  - Belt progress tracking maintained after playback swap
  - All 22 tests passing
- [x] p3-5: Verify listening mode still works - COMPLETE
  - Listening mode uses handlePause() which calls stopCycle()
  - stopCycle() from useCyclePlayback stops audio and clears state
  - handleResume() restarts playback normally
  - ListeningOverlay integration maintained
  - All 22 tests passing
- [ ] p3-6: Remove old CycleOrchestrator usage

### Ralph Loop Ready
- PRD: ralph-prd-phase3.json (6 tasks)
- Prompt: ralph-prompt-phase3.md
- Completion signal: <promise>CYCLE_INTEGRATION_COMPLETE</promise>
